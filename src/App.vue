<script setup>
import { ref, onMounted } from 'vue';
import axios from 'axios';
import { messaging, solicitarToken } from '@/firebase';
import { onMessage } from 'firebase/messaging';

const trackingCode = ref('');
const trackingResult = ref(null);
const error = ref('');
const loading = ref(false);
const trackingHistory = ref([]);
const pushToken = ref(null);
const snackbar = ref(false);
const notificationMessage = ref('');

const rules = [
  (value) => !!value || 'C√≥digo de rastreio √© obrigat√≥rio',
  (value) => /^[A-Z]{2}\d{9}[A-Z]{2}$/.test(value) || 'C√≥digo deve ter 13 caracteres (ex: AA123456789BR)',
];

const getFCMToken = async () => {
  try {
    const savedToken = localStorage.getItem('pushSubscriptionId');
    if (savedToken) {
      console.log('üîÅ Token FCM reutilizado do localStorage:', savedToken);
      pushToken.value = savedToken;
      return savedToken;
    }

    const vapidKey = "BH360oAapgSM9MQwKP_TvJSVZlI2bncllkNGRpQw9Utx0EA5YwUwwJKZp3_GOeAmYvk0Wmuvo3LtArQ7y-XZidQ";
    const token = await solicitarToken(vapidKey);
    if (token) {
      console.log('‚úÖ Token FCM armazenado:', token);
      pushToken.value = token;
      localStorage.setItem('pushSubscriptionId', token);
      return token;
    } else {
      console.warn('‚ö†Ô∏è Nenhum token FCM recuperado. A permiss√£o pode n√£o ter sido concedida.');
      return null;
    }
  } catch (err) {
    console.error('‚ùå Erro ao obter token FCM:', err);
    error.value = 'Erro ao obter token de notifica√ß√£o: ' + err.message;
    return null;
  }
};

const registerPushToken = async (token, code) => {
  try {
    await axios.post('http://localhost:8080/api/register-push-token', {
      trackingCode: code,
      pushToken: token
    });
    console.log('Token FCM registrado para o c√≥digo:', code);
  } catch (err) {
    console.warn('Falha ao registrar token FCM:', err.response?.data || err.message);
    error.value = 'Falha ao registrar token: ' + (err.response?.data || err.message);
  }
};

onMounted(async () => {
  const savedHistory = localStorage.getItem('trackingHistory');
  if (savedHistory) {
    trackingHistory.value = JSON.parse(savedHistory);
  }

  try {
    const permission = await Notification.requestPermission();
    console.log('Permiss√£o de notifica√ß√£o:', permission);

    if (permission === 'granted') {
      await getFCMToken();

      onMessage(messaging, (payload) => {
        console.log('Mensagem recebida em foreground:', payload);
        const title = payload.notification?.title || 'Nova Atualiza√ß√£o';
        const body = payload.notification?.body || 'Seu pacote foi atualizado.';
        notificationMessage.value = `${title}: ${body}`;
        snackbar.value = true;
      });
    } else {
      console.warn('Permiss√£o de notifica√ß√£o negada.');
    }
  } catch (err) {
    console.error('Erro ao inicializar notifica√ß√µes:', err);
    error.value = 'Erro ao inicializar notifica√ß√µes push: ' + err.message;
  }
});

const trackPackage = async () => {
  error.value = '';
  trackingResult.value = null;
  loading.value = true;

  try {
    const response = await axios.post('http://localhost:8080/api/track', { code: trackingCode.value });
    console.log('Resposta bruta /api/track:', response);

    if (!response.data || typeof response.data !== 'object' || !('json' in response.data)) {
      throw new Error('Resposta inv√°lida do servidor: campo "json" ausente ou malformado.');
    }

    let result;
    try {
      const jsonString = response.data.json.trim();
      if (typeof jsonString !== 'string') throw new Error('Campo JSON n√£o √© uma string.');
      result = JSON.parse(jsonString);
    } catch (parseErr) {
      throw new Error('Erro ao interpretar resposta JSON: ' + parseErr.message);
    }

    if (result.erro) {
      error.value = result.mensagem || 'Erro ao consultar o rastreio.';
      return;
    }

    trackingResult.value = result;

    if (trackingResult.value.eventos) {
      if (trackingResult.value.codObjeto) {
        trackingHistory.value = trackingHistory.value.filter(
          entry => entry.result.codObjeto !== trackingResult.value.codObjeto
        );
      }

      const historyEntry = {
        code: trackingCode.value,
        result: trackingResult.value,
        timestamp: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }),
      };
      trackingHistory.value.unshift(historyEntry);
      localStorage.setItem('trackingHistory', JSON.stringify(trackingHistory.value));

      const token = pushToken.value || await getFCMToken();
      if (token) {
        await registerPushToken(token, trackingCode.value);
      } else {
        console.warn('Nenhum token FCM dispon√≠vel para registrar.');
      }
    }
  } catch (err) {
    error.value = err.response?.data?.message || 'Erro ao consultar o rastreio: ' + err.message;
    console.error('Erro de rastreamento:', err);
  } finally {
    loading.value = false;
  }
};

const formatDateTime = (dateObj) => {
  if (!dateObj?.date) return '-';
  const date = new Date(dateObj.date.replace(' ', 'T'));
  return date.toLocaleString('pt-BR', { timeZone: dateObj.timezone || 'America/Sao_Paulo' });
};

const getLocation = (unidade) => {
  if (!unidade) return '-, -';
  const city = unidade.endereco?.cidade || unidade.nome || '-';
  const uf = unidade.endereco?.uf || '-';
  return `${city}, ${uf}`;
};

const getTransitDays = () => {
  const eventos = trackingResult.value?.eventos || [];
  const postagem = eventos.find(e => e.descricaoFrontEnd === 'Postado');
  const entrega = eventos.find(e => e.descricaoFrontEnd === 'ENTREGUE');

  if (!postagem) return { days: '-', label: 'dias' };

  const start = new Date(postagem.dtHrCriado.date.replace(' ', 'T'));
  const end = entrega ? new Date(entrega.dtHrCriado.date.replace(' ', 'T')) : new Date();

  const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
  return { days: diff, label: diff === 1 ? 'dia' : 'dias' };
};

const getEventColor = (event) => {
  if (event.finalizador === 'S') return 'success';
  if (event.descricaoFrontEnd === 'Postado') return 'teal';
  return 'primary';
};

const viewHistoryEntry = (entry) => {
  trackingCode.value = entry.code;
  trackingResult.value = entry.result;
  error.value = '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

const formatTimestamp = (timestamp) => {
  return new Date(timestamp).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
};

const getLatestStatus = (result) => {
  return result?.eventos?.[0]?.descricaoFrontEnd || '-';
};
</script>

<template>
  <v-container>
    <v-row justify="center">
      <v-col cols="12" md="8">
        <v-card class="pa-4">
          <v-card-title class="text-h2 text-center">
            <a href="#" @click.prevent="refreshPage" class="text-decoration-none" color="white"
              style="color: white !important;">
              Trackin - App
            </a>
          </v-card-title>
          <v-card-title class="text-h5 text-center">Rastreamento de Encomendas - Correios</v-card-title>
          <v-card-text>
            <v-form @submit.prevent="trackPackage">
              <v-text-field v-model="trackingCode" label="C√≥digo de Rastreio" placeholder="Ex: AA123456789BR"
                :rules="rules" counter="13" maxlength="13" prepend-inner-icon="mdi-package-variant"
                :disabled="loading"></v-text-field>
              <v-btn type="submit" color="primary" block :loading="loading" :disabled="!trackingCode || loading">
                Rastrear
              </v-btn>
            </v-form>
            <v-alert v-if="error" type="error" class="mt-4" dismissible @update:model-value="error = ''">
              {{ error }}
            </v-alert>
            <v-snackbar v-model="snackbar" :timeout="5000" color="info" location="top">
              {{ notificationMessage }}
              <template v-slot:actions>
                <v-btn color="white" variant="text" @click="snackbar = false">
                  Fechar
                </v-btn>
              </template>
            </v-snackbar>
            <v-card v-if="trackingResult && !error" class="mt-4">
              <v-card-title>Detalhes do Rastreamento</v-card-title>
              <v-card-text>
                <v-row>
                  <v-col cols="12" sm="6">
                    <strong>C√≥digo:</strong> {{ trackingResult.codObjeto || '-' }}
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Tipo:</strong> {{ trackingResult.tipoPostal?.descripcion || '-' }}
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Categoria:</strong> {{ trackingResult.tipoPostal?.categoria || '-' }}
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Previs√£o de Entrega:</strong> {{ trackingResult.dtPrevista || '-' }}
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Situa√ß√£o:</strong>
                    <v-chip
                      :color="trackingResult.situacao === 'E' ? 'success' : trackingResult.situacao === 'T' ? 'warning' : 'info'">
                      {{ trackingResult.situacao === 'E' ? 'Entregue' : trackingResult.situacao === 'T' ? 'Em tr√¢nsito'
                        :
                        'Desconhecida' }}
                    </v-chip>
                    <span class="ml-2">
                      ({{ getTransitDays().days }} {{ getTransitDays().label }} em transporte)
                    </span>
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Modalidade:</strong> {{ trackingResult.modalidade === 'F' ? 'PAC' : 'Desconhecida' }}
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Bloqueio:</strong>
                    <v-chip :color="trackingResult.bloqueioObjeto ? 'error' : 'success'">
                      {{ trackingResult.bloqueioObjeto ? 'Sim' : 'N√£o' }}
                    </v-chip>
                  </v-col>
                  <v-col cols="12" sm="6">
                    <strong>Atrasado:</strong>
                    <v-chip :color="trackingResult.atrasado ? 'error' : 'success'">
                      {{ trackingResult.atrasado ? 'Sim' : 'N√£o' }}
                    </v-chip>
                  </v-col>
                </v-row>
                <v-divider class="my-4"></v-divider>
                <h3>Eventos</h3>
                <v-timeline side="end" density="compact">
                  <v-timeline-item v-for="(event, index) in trackingResult.eventos" :key="index"
                    :dot-color="getEventColor(event)">
                    <v-card :class="event.descricaoFrontEnd === 'Postado' ? 'bg-cosmic' : ''">
                      <v-card-title
                        :class="getEventColor(event) === 'cosmic' ? 'text-cosmic' : `text-${getEventColor(event)}`">
                        {{ event.descricaoFrontEnd || '-' }}
                      </v-card-title>
                      <v-card-text>
                        <p><strong>Data/Hora:</strong> {{ formatDateTime(event.dtHrCriado) }}</p>
                        <p><strong>Local:</strong> {{ getLocation(event.unidade) }}</p>
                        <p><strong>Detalhes:</strong> {{ event.detalhe || '-' }}</p>
                        <p v-if="event.unidadeDestino">
                          <strong>Destino:</strong> {{ getLocation(event.unidadeDestino) }}
                        </p>
                      </v-card-text>
                    </v-card>
                  </v-timeline-item>
                </v-timeline>
              </v-card-text>
            </v-card>
            <v-card v-if="trackingHistory.length > 0" class="mt-4">
              <v-card-title>Hist√≥rico de Rastreamento</v-card-title>
              <v-list>
                <v-list-item v-for="(entry, index) in trackingHistory" :key="index" @click="viewHistoryEntry(entry)"
                  class="history-item">
                  <v-list-item-title class="text-primary">
                    {{ entry.code }}
                  </v-list-item-title>
                  <v-list-item-subtitle class="history-subtitle">
                    <strong>√öltimo Status:</strong>
                    <span :class="getLatestStatus(entry.result) === 'ENTREGUE' ? 'text-success' : ''">
                      {{ getLatestStatus(entry.result) }}
                    </span>
                  </v-list-item-subtitle>
                  <v-list-item-subtitle class="history-subtitle">
                    <strong>Rastreamento em:</strong> {{ formatTimestamp(entry.timestamp) }}
                  </v-list-item-subtitle>
                </v-list-item>
              </v-list>
            </v-card>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>

<style scoped>
.v-card {
  border-radius: 8px !important;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
}

.v-card-title {
  font-weight: 500 !important;
}

.v-card-title.text-h5 {
  text-align: center;
}

.v-card-title.text-h2 {
  text-align: center;
}

.v-timeline-item .v-card {
  margin-bottom: 16px;
}

:root {
  --cosmic-color: #6A1B9A;
}

.v-timeline-item .v-timeline-dot:has(+ .v-card .v-card-title.text-cosmic) {
  background-color: var(--cosmic-color) !important;
}

.text-cosmic {
  color: var(--cosmic-color) !important;
}

.bg-cosmic {
  background-color: var(--cosmic-color) !important;
}

.v-timeline-item .v-card.bg-cosmic .v-card-text {
  color: #fff !important;
}

.history-item {
  cursor: pointer;
  transition: background-color 0.2s;
  padding: 16px;
  margin-bottom: 8px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.history-item:last-child {
  border-bottom: none;
}

.history-item:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.history-subtitle {
  margin-bottom: 8px;
}

@media (max-width: 600px) {
  .v-card {
    padding: 12px !important;
  }

  .v-card-title {
    font-size: 1.25rem !important;
  }

  .history-item {
    padding: 12px;
  }
}
</style>
